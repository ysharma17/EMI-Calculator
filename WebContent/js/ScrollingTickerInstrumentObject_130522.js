
/************************************
* Developed by Illimar Pihlamäe		*
* e-mail: illimar@idra.pri.ee		*
* Euroland Estonia © 2012			*
* e-mail: illimar@euroland.com		*
*************************************/

var ScrollingTickerInstrumentsSetArr=[];var ScrollingTickerInstrumentObject=function(_Settings,preserveLayout,instrumentsSetIndex,canUseCustomContainerTag){this.dom=null; this.Values=[]; this.updateIntervall=60; this.timer=null; this.getDataCall=null;	this.previousWidth=0;this.Settings=_Settings;this.hasInitialInstrument=false;var InternalIntrumentsArr=[],InstrumentSetArr,This=this,ContainerDomsWithChangeArr=[];this.addValue=function(ID,dom,format,originalClass,strClassName){var obj={name:null,isChange:false,value:document.createTextNode(' '),dom:document.createElement('span'),format:this.numberFormat,originalClass:originalClass,strValue:""};if(typeof format=='string'&&format.length > 0){obj.format=format;}obj.name=ID;switch(ID){case "change":obj.isChange=true;break;case "changePer":obj.isChange=true;break;case "volume":if(format.length==0){obj.format="#,##0";}break;case "date":if(format.length==0){obj.format="g";}break;}this.Values.push(obj);if(dom==null){obj.value=null;return;} obj.dom.className=obj.name;if(typeof strClassName=='string'&&strClassName.length > 0){obj.dom.className+=' '+strClassName;}obj.dom.appendChild(obj.value);dom.appendChild(obj.dom);};function addItemToContainerDomsWithChangeArr(className,dom){ContainerDomsWithChangeArr.push({"originalClass":className,'dom':dom});}this.addItems=function(arr,mainDom){var i,item,dom,obj,addChange=false,addChangePer=false;for(i=0;i < arr.length;i++){item=arr[i];item.tag=item.tag.toLowerCase();switch(item.tag){case "instrument":if(item.Settings==null)break;obj=new ScrollingTickerInstrumentObject(item.Settings,preserveLayout,instrumentsSetIndex,true);InternalIntrumentsArr.push(obj);if(item.className.length > 0){item.className=obj.dom.className+' '+item.className;obj.dom.className=item.className;}if(item.className.indexOf("[changePer]")>-1){addChangePer=true;addItemToContainerDomsWithChangeArr(item.className,obj.dom);}else if(item.className.indexOf("[change]")>-1){addChange=true;addItemToContainerDomsWithChangeArr(item.className,obj.dom);}mainDom.appendChild(obj.dom);break;case "br":case "div":case "table":case "tr":case "td":if(!this.allowsBreaks)break;case "b":case "i":case "span":case "a":dom=document.createElement(item.tag);if(item.className.length > 0)dom.className=item.className;if(!this.allowsBreaks){dom.style.whiteSpace='nowrap';}mainDom.appendChild(dom);switch(item.tag){case 'table':	obj=document.createElement('tbody');dom.appendChild(obj);dom=obj;break;case 'a':	dom.href=item.href.length ? item.href:'#';dom.target=item.target;break;}if(item.Children!=null&&item.Children.length > 0){this.addItems(item.Children,dom);}if(item.className.indexOf("[changePer]")>-1){addChangePer=true;addItemToContainerDomsWithChangeArr(item.className,dom);}else if(item.className.indexOf("[change]")>-1){addChange=true;addItemToContainerDomsWithChangeArr(item.className,dom);}break;case "text":dom=document.createTextNode(this.Settings.isArabic ? this.arabic_nr(item.value):item.value);mainDom.appendChild(dom);if(item.hasSpace){mainDom.appendChild(document.createTextNode(" "));}break;case "img":dom=new Image();var temp=item.src.substring(0,2);switch(temp){case '~/':case '~\\':item.src=item.src.substr(2);item.src=this.appBaseLocation+item.src;break;default:break;}dom.src=item.src;dom.className=item.className;if(item.width >-1)dom.width=item.width;if(item.height >-1)dom.height=item.height;if(item.className.indexOf("[changePer]")>-1){addChangePer=true;addItemToContainerDomsWithChangeArr(item.className,dom);}else if(item.className.indexOf("[change]")>-1){addChange=true;addItemToContainerDomsWithChangeArr(item.className,dom);}mainDom.appendChild(dom);break;case "value":if(item.className.indexOf("[changePer]")>-1||item.className.indexOf("[change]")>-1){this.addValue(item.value,mainDom,item.format,item.className);}else{this.addValue(item.value,mainDom,item.format,null,item.className);}if(item.hasSpace){mainDom.appendChild(document.createTextNode(" "));}break;}}i=this.Values.length;while(i--){obj=this.Values[i];if(obj.name=='change')addChange=false;if(obj.name=='changePer')addChangePer=false;}if(addChange)this.addValue('change',null);if(addChangePer)this.addValue('changePer',null);};this.updateValues=function(){var parent=this,items='',formats='',indices='',index,obj,parms;if(this.hasInitialInstrument)return;if(this.Values.length==0){parent.timer=setTimeout(function(){parent.updateValues();},parent.updateIntervall*1000);return;}for(index=0;index < this.Values.length;index++){obj=this.Values[index];if(items.length > 0){items+='|';formats+='|';}items+=obj.name;formats+=encodeURIComponent(obj.format);indices+=index;}parms='instrumentID='+this.Settings.instrumentID+'&lang='+this.lang+'&decimalMarket='+this.decimalMarket+'&thousandGroupMarker='+this.thousandGroupMarker+'&values='+items+'&timeZone='+this.Settings.timeZone+'&formats='+formats;this.getDataCall(this.dataURI,parms,function(data){parent.loadUpdatedValues(data,parms);},parms.length > 1500,null,null,function(){parent.timer=setTimeout(function(){parent.updateValues();},parent.updateIntervall*1000);});};function setChangeClassName(strValueName,result){var index=This.Values.length,item,pattern,value;	if(result.isBigger > 0)value='positive';else if(result.isBigger < 0)value='negative';else	value='neutral';	switch(strValueName){case 'change':pattern=/\[change\]/g;break;case 'changePer':pattern=/\[changePer\]/g;break;default:return;}	while(index--){item=This.Values[index];if(typeof item.originalClass!='string'||item.dom==null)continue;item.dom.className=item.originalClass.replace(pattern,value);}index=ContainerDomsWithChangeArr.length;while(index--){item=ContainerDomsWithChangeArr[index];item.dom.className=item.originalClass.replace(pattern,value);}}function throwErrorToServer(from,message){if(typeof This.errorLogUri=='string'){}This.timer=setTimeout(function(){This.updateValues();},This.updateIntervall*1000);}this.loadUpdatedValues=function(data,parms){var index,obj,item;try{data=JSON.parse(data);}catch(e){throwErrorToServer("ScrollingTickerInstrumentObject","JSON Phraser Error - PARMS:"+encodeURIComponent(parms)+" DATA: "+encodeURIComponent(data));return;}this.previousWidth=parseFloat(this.dom.offsetWidth);if(typeof data.error=='string'){if(data.error.length > 0){throwErrorToServer("ScrollingTickerInstrumentObject","Controlled Error - PARMS:"+encodeURIComponent(parms)+" ERROR Message: "+data.error);}return;}for(index=0;index < this.Values.length;index++){obj=this.Values[index];item=data.Values[index];if(obj.isChange){setChangeClassName(obj.name,item);if(obj.value==null)	continue;}obj.dom.removeChild(obj.value);obj.strValue="";switch(typeof item){case "string":obj.strValue=item;break;case "object":obj.strValue=item.value;obj.dom.className=obj.name;if(item.isBigger > 0)obj.dom.className+=' positive positive_'+obj.name;else if(item.isBigger < 0)obj.dom.className+=' negative negative_'+obj.name;else	obj.dom.className+=' neutral neutral_'+obj.name;break;case "boolean":	obj.strValue=item ? this.Settings.summerTimeMarker:this.Settings.winterTimeMarker;break;}if(this.Settings.isArabic)obj.strValue=this.arabic_nr(obj.strValue);obj.value=document.createTextNode(obj.strValue);obj.dom.appendChild(obj.value);}if(typeof this.loadedCall=='function'){this.loadedCall(This);}this.timer=setTimeout(function(){This.updateValues();},this.updateIntervall*1000);};this.arabic_nr=function(str){str=''+str;var new_str="";var str_char=null;for(var i=0;i <=str.length;i++){str_char=str.charAt(i);switch(str_char){case "1":str_char="١";break;case "2":str_char="٢";break;case "3":str_char="٣";break;case "4":str_char="٤";break;case "5":str_char="٥";break;case "6":str_char="٦";break;case "7":str_char="٧";break;case "8":str_char="٨";break;case "9":str_char="٩";break;case "0":str_char="٠";break;default:}new_str+=str_char;}str=new_str;return str;};this.load=function(){if(!this.hasInitialInstrument)this.updateValues();var index=InternalIntrumentsArr.length;while(index--){InternalIntrumentsArr[index].load();}};this.sysLoad=function(){if(this.Settings==null||typeof this.Settings.instrumentID!='number'&&this.Settings.instrumentID < 1){this.dom=document.createElement('span');return;}if(typeof this.lang!='string'){this.lang="en-GB";}if(typeof this.decimalMarket!='string'){this.decimalMarket=".";}if(typeof this.thousandGroupMarker!='string'){this.thousandGroupMarker=",";}if(typeof this.numberFormat!='string'){this.numberFormat="#,##0.00";}if(typeof this.timeZoneOffset!='number'){this.timeZoneOffset=0;}if(typeof this.dataURI!='string'){this.dataURI="GetOrderedData";}if(typeof this.isAzure!='boolean')this.isAzure=false;if(this.isAzure&&document.all){this.getDataCall=Page.DomainData.getData;}else{this.getDataCall=Page.getData;}if(typeof this.allowsBreaks!='boolean')this.allowsBreaks=false;if(typeof this.isDomSpan!='boolean')this.isDomSpan=true;if(typeof isArabic=='boolean')this.isArabic=isArabic;if(typeof instrumentsSetIndex!='number')instrumentsSetIndex=0;InstrumentSetArr=ScrollingTickerInstrumentsSetArr['set_'+instrumentsSetIndex];if(typeof InstrumentSetArr!='object'||InstrumentSetArr==null||typeof InstrumentSetArr.length!='number'){InstrumentSetArr=[];ScrollingTickerInstrumentsSetArr['set_'+instrumentsSetIndex]=InstrumentSetArr;}if(canUseCustomContainerTag&&this.Settings.containerTag.length > 0)this.dom=document.createElement(this.Settings.containerTag);else	this.dom=document.createElement(this.isDomSpan ? 'span':'div');this.lang=encodeURIComponent(this.lang);this.decimalMarket=encodeURIComponent(this.decimalMarket);this.thousandGroupMarker=encodeURIComponent(this.thousandGroupMarker);this.dom.className='instrument instrument_'+this.Settings.instrumentID;var index=InstrumentSetArr.length,ret=null;while(index--){ret=InstrumentSetArr[index];if(ret.Settings.instrumentID==this.Settings.instrumentID&&ret.Settings.timeZone==this.Settings.timeZone){ret.addItems(this.Settings.Layout,this.dom);this.hasInitialInstrument=true;break;}ret=null;}if(ret==null){InstrumentSetArr.push(this);this.addItems(this.Settings.Layout,this.dom);ret=this;}if(!preserveLayout){delete this.Settings.Layout;}};this.sysLoad();};